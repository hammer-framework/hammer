import rdl from 'readline'

import execa from 'execa'

import { getPaths } from '../../../../lib'

import type { ISpinnerAnimation } from './interfaces'
import { ISpawnResult } from './interfaces'

export async function spawn(
  command: string,
  opts?: execa.Options
): Promise<ISpawnResult> {
  const [bin, ...args] = command.split(' ')
  const {
    stdout = '',
    stderr = '',
    exitCode,
  }: execa.ExecaReturnValue = await execa(bin, args, {
    cwd: getPaths().base,
    reject: false,
    // if reject is true, stdio needs to inherit to catch the throw
    stdio: opts?.reject ? 'inherit' : 'pipe',
    cleanup: true,
    stripFinalNewline: true,
    ...opts,
  })
  return { stdout, stderr, exitCode }
}

export class Logger {
  static out(msg: string) {
    process.stdout.write(`­Ъџђ ${msg}\x1b[0G`)
  }

  static error(msg: string) {
    console.error(`РЮї ${msg}`)
  }

  static log(...args: any) {
    console.log(args)
  }
}

export class Spinner {
  private _spinner = rdl.createInterface({
    input: process.stdin,
    output: process.stdout,
  })
  private _animation: ISpinnerAnimation
  private _message = ''

  constructor(animation = SPINNER_ANIMATIONS['dots']) {
    this._animation = animation
  }

  start(message: string) {
    ;(async () => {
      this._message = message
      // eslint-disable-next-line no-constant-condition
      while (true) {
        for (const animation of this._animation.frames) {
          this._spinner.setPrompt(`${animation} ${this._message}`)
          this._spinner.prompt()
          await this.sleep(this._animation.interval)
        }
      }
    })()
  }

  prompt(message: string) {
    this._spinner.setPrompt(`${message}`)
    this._spinner.prompt()
  }

  stop() {
    this._spinner.close()
  }

  setAnimation(animation: ISpinnerAnimation) {
    this._animation = animation
  }

  private sleep(time: number) {
    return new Promise((resolve) => setTimeout(resolve, time))
  }
}

export const SPINNER_ANIMATIONS: { [key: string]: ISpinnerAnimation } = {
  dots: {
    interval: 80,
    frames: ['РаІ', 'РаЎ', 'Ра╣', 'РаИ', 'Ра╝', 'Ра┤', 'Рад', 'РаД', 'РаЄ', 'РаЈ'],
  },
  dots2: {
    interval: 80,
    frames: [
      'РаЂ',
      'РаЂ',
      'РаЅ',
      'РаЎ',
      'Раџ',
      'Рањ',
      'Раѓ',
      'Раѓ',
      'Рањ',
      'Ра▓',
      'Ра┤',
      'Рац',
      'Раё',
      'Раё',
      'Рац',
      'Раа',
      'Раа',
      'Рац',
      'Рад',
      'Раќ',
      'Рањ',
      'Раљ',
      'Раљ',
      'Рањ',
      'РаЊ',
      'РаІ',
      'РаЅ',
      'Раѕ',
      'Раѕ',
    ],
  },
  dots3: {
    interval: 80,
    frames: [
      'РаЂ',
      'Раѓ',
      'Раё',
      'РАђ',
      'РАѕ',
      'РАљ',
      'РАа',
      'РБђ',
      'РБЂ',
      'РБѓ',
      'РБё',
      'РБї',
      'РБћ',
      'РБц',
      'РБЦ',
      'РБд',
      'РБ«',
      'РБХ',
      'РБи',
      'РБ┐',
      'РА┐',
      'Ра┐',
      'РбЪ',
      'РаЪ',
      'РАЏ',
      'РаЏ',
      'РаФ',
      'РбІ',
      'РаІ',
      'РаЇ',
      'РАЅ',
      'РаЅ',
      'РаЉ',
      'РаА',
      'РбЂ',
    ],
  },
  square: {
    interval: 100,
    frames: ['Рќа', 'РќА', 'Рќф', 'РќФ'],
  },
  bar: {
    interval: 80,
    frames: [
      '[    ]',
      '[=   ]',
      '[==  ]',
      '[=== ]',
      '[ ===]',
      '[  ==]',
      '[   =]',
      '[    ]',
      '[   =]',
      '[  ==]',
      '[ ===]',
      '[====]',
      '[=== ]',
      '[==  ]',
      '[=   ]',
    ],
  },
  ball: {
    interval: 80,
    frames: [
      '( РЌЈ    )',
      '(  РЌЈ   )',
      '(   РЌЈ  )',
      '(    РЌЈ )',
      '(     РЌЈ)',
      '(    РЌЈ )',
      '(   РЌЈ  )',
      '(  РЌЈ   )',
      '( РЌЈ    )',
      '(РЌЈ     )',
    ],
  },
  solidBar: {
    interval: 17,
    frames: [
      'РќѕРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂ',
      'РќѕРќѕРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂ',
      'РќѕРќѕРќѕРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂ',
      'РќѕРќѕРќѕРќѕРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂ',
      'РќѕРќѕРќѕРќѕРќѕРќѕРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂ',
      'РќѕРќѕРќѕРќѕРќѕРќѕРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂ',
      'РќѕРќѕРќѕРќѕРќѕРќѕРќѕРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂ',
      'РќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂ',
      'РќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂ',
      'РќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂ',
      'РќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂ',
      'РќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂ',
      'РќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќЂРќЂРќЂРќЂРќЂРќЂРќЂ',
      'РќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќЂРќЂРќЂРќЂРќЂРќЂ',
      'РќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќЂРќЂРќЂРќЂРќЂРќЂ',
      'РќЂРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќЂРќЂРќЂРќЂРќЂ',
      'РќЂРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќЂРќЂРќЂРќЂРќЂ',
      'РќЂРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќЂРќЂРќЂРќЂРќЂ',
      'РќЂРќЂРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќЂРќЂРќЂРќЂ',
      'РќЂРќЂРќЂРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќЂРќЂРќЂ',
      'РќЂРќЂРќЂРќЂРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќЂРќЂРќЂ',
      'РќЂРќЂРќЂРќЂРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќЂРќЂ',
      'РќЂРќЂРќЂРќЂРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќЂРќЂ',
      'РќЂРќЂРќЂРќЂРќЂРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќЂ',
      'РќЂРќЂРќЂРќЂРќЂРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќЂ',
      'РќЂРќЂРќЂРќЂРќЂРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќЂ',
      'РќЂРќЂРќЂРќЂРќЂРќЂРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕ',
      'РќЂРќЂРќЂРќЂРќЂРќЂРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕ',
      'РќЂРќЂРќЂРќЂРќЂРќЂРќЂРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕ',
      'РќЂРќЂРќЂРќЂРќЂРќЂРќЂРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕ',
      'РќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕ',
      'РќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕ',
      'РќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕ',
      'РќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕ',
      'РќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕ',
      'РќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕ',
      'РќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕ',
      'РќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќѕРќѕРќѕРќѕРќѕРќѕРќѕ',
      'РќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќѕРќѕРќѕРќѕРќѕРќѕ',
      'РќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќѕРќѕРќѕРќѕРќѕ',
      'РќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќѕРќѕРќѕРќѕРќѕ',
      'РќѕРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќѕРќѕРќѕРќѕ',
      'РќѕРќѕРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќѕРќѕРќѕ',
      'РќѕРќѕРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќѕРќѕРќѕ',
      'РќѕРќѕРќѕРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќѕРќѕРќѕ',
      'РќѕРќѕРќѕРќѕРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќѕРќѕ',
      'РќѕРќѕРќѕРќѕРќѕРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќѕ',
      'РќѕРќѕРќѕРќѕРќѕРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќѕ',
      'РќѕРќѕРќѕРќѕРќѕРќѕРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќѕ',
      'РќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂ',
      'РќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂ',
      'РќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂ',
      'РќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂ',
      'РќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂ',
      'РќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂ',
      'РќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂ',
      'РќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂ',
      'РќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќЂРќЂРќЂРќЂРќЂРќЂ',
      'РќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќЂРќЂРќЂРќЂРќЂРќЂ',
      'РќЂРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќЂРќЂРќЂРќЂРќЂ',
      'РќЂРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќЂРќЂРќЂРќЂРќЂ',
      'РќЂРќЂРќЂРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќЂРќЂРќЂРќЂ',
      'РќЂРќЂРќЂРќЂРќЂРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќЂРќЂРќЂ',
      'РќЂРќЂРќЂРќЂРќЂРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќЂРќЂРќЂ',
      'РќЂРќЂРќЂРќЂРќЂРќЂРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќЂРќЂРќЂ',
      'РќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќЂРќЂРќЂ',
      'РќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќЂРќЂРќЂ',
      'РќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќЂРќЂ',
      'РќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќЂРќЂ',
      'РќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќЂ',
      'РќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќЂ',
      'РќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќЂ',
      'РќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќЂ',
      'РќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќѕРќѕРќѕРќѕРќѕРќѕРќѕРќЂ',
      'РќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќѕРќѕРќѕРќѕРќѕРќѕРќѕ',
      'РќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќѕРќѕРќѕРќѕРќѕРќѕРќѕ',
      'РќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќѕРќѕРќѕРќѕРќѕ',
      'РќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќѕРќѕРќѕРќѕ',
      'РќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќѕРќѕРќѕРќѕ',
      'РќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќѕРќѕРќѕРќѕ',
      'РќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќѕРќѕРќѕ',
      'РќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќѕРќѕРќѕ',
      'РќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќѕРќѕ',
      'РќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќѕРќѕ',
      'РќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќѕРќѕ',
      'РќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќѕ',
      'РќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќѕ',
      'РќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќѕ',
      'РќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂ',
      'РќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂ',
      'РќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂ',
      'РќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂРќЂ',
    ],
  },
  tree: {
    interval: 400,
    frames: ['­Ъї▓', '­Ъјё'],
  },
  point: {
    interval: 125,
    frames: ['РѕЎРѕЎРѕЎ', 'РЌЈРѕЎРѕЎ', 'РѕЎРЌЈРѕЎ', 'РѕЎРѕЎРЌЈ', 'РѕЎРѕЎРѕЎ'],
  },
  mindblown: {
    interval: 160,
    frames: [
      '­Ъўљ ',
      '­Ъўљ ',
      '­Ъў« ',
      '­Ъў« ',
      '­Ъўд ',
      '­Ъўд ',
      '­ЪўД ',
      '­ЪўД ',
      '­Ъц» ',
      '­ЪњЦ ',
      'Рюе ',
      '\u3000 ',
      '\u3000 ',
      '\u3000 ',
    ],
  },
}
